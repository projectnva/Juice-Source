package com.github.lunatrius.schematica.client.printer.nbtsync;

import io.netty.buffer.Unpooled;
import net.minecraft.command.server.CommandBlockLogic;
import net.minecraft.network.PacketBuffer;
import net.minecraft.network.play.client.C17PacketCustomPayload;
import net.minecraft.tileentity.TileEntity;
import net.minecraft.tileentity.TileEntityCommandBlock;
import net.minecraft.util.BlockPos;
import net.minecraft.world.World;

public class NBTSyncCommandBlock extends NBTSync {

    public boolean execute(World schematic, BlockPos pos, World mcWorld, BlockPos mcPos) {
        TileEntity tileEntity = schematic.getTileEntity(pos);
        TileEntity mcTileEntity = mcWorld.getTileEntity(mcPos);

        if (tileEntity instanceof TileEntityCommandBlock && mcTileEntity instanceof TileEntityCommandBlock) {
            CommandBlockLogic commandBlockLogic = ((TileEntityCommandBlock) tileEntity).getCommandBlockLogic();
            CommandBlockLogic mcCommandBlockLogic = ((TileEntityCommandBlock) mcTileEntity).getCommandBlockLogic();

            if (!commandBlockLogic.getCommand().equals(mcCommandBlockLogic.getCommand())) {
                PacketBuffer packetBuffer = new PacketBuffer(Unpooled.buffer());

                packetBuffer.writeByte(mcCommandBlockLogic.func_145751_f());
                mcCommandBlockLogic.func_145757_a(packetBuffer);
                packetBuffer.writeString(commandBlockLogic.getCommand());
                packetBuffer.writeBoolean(mcCommandBlockLogic.shouldTrackOutput());
                return this.sendPacket(new C17PacketCustomPayload("MC|AdvCdm", packetBuffer));
            }
        }

        return false;
    }
}
